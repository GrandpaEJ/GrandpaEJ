name: Update GitHub Stats

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  update-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
      
      - name: Fetch GitHub Stats
        id: stats
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Fetch user data
          USER_DATA=$(curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/users/GrandpaEJ")
          
          # Extract stats
          REPOS=$(echo "$USER_DATA" | jq '.public_repos')
          FOLLOWERS=$(echo "$USER_DATA" | jq '.followers')
          
          # Fetch all repos to calculate total stars
          REPOS_DATA=$(curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/users/GrandpaEJ/repos?per_page=100")
          
          TOTAL_STARS=$(echo "$REPOS_DATA" | jq '[.[].stargazers_count] | add // 0')
          
          echo "repos=$REPOS" >> $GITHUB_OUTPUT
          echo "followers=$FOLLOWERS" >> $GITHUB_OUTPUT
          echo "stars=$TOTAL_STARS" >> $GITHUB_OUTPUT
          
          echo "ðŸ“Š Stats fetched:"
          echo "  Repos: $REPOS"
          echo "  Followers: $FOLLOWERS"  
          echo "  Total Stars: $TOTAL_STARS"
      
      - name: Update index.html with stats
        run: |
          REPOS="${{ steps.stats.outputs.repos }}"
          FOLLOWERS="${{ steps.stats.outputs.followers }}"
          STARS="${{ steps.stats.outputs.stars }}"
          
          # Use perl for proper multiline regex matching
          # Update Repos stat
          perl -i -0pe "s|(<span class=\"stat-number\">)[^<]*(</span>\s*<span class=\"stat-label\">Repos)|\${1}${REPOS}\${2}|gs" index.html
          
          # Update Followers stat
          perl -i -0pe "s|(<span class=\"stat-number\">)[^<]*(</span>\s*<span class=\"stat-label\">Followers)|\${1}${FOLLOWERS}\${2}|gs" index.html
          
          # Update Stars stat
          perl -i -0pe "s|(<span class=\"stat-number\">)[^<]*(</span>\s*<span class=\"stat-label\">Stars)|\${1}${STARS}\${2}|gs" index.html
          
          echo "âœ… Updated stats: Repos=$REPOS, Followers=$FOLLOWERS, Stars=$STARS"
      
      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if there are changes
          if git diff --quiet; then
            echo "ðŸ“Š No changes to commit - stats are already up to date"
          else
            git add index.html
            git commit -m "ðŸ“Š Auto-update stats: $(date +'%Y-%m-%d')"
            git push
            echo "âœ… Changes pushed successfully"
          fi
